<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <title>Query Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        .loader { display: none; border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #sqlQueryDisplay pre, #modalSqlToConfirm { background-color: #f8f9fa; border: 1px solid #dee2e6; padding: 10px; border-radius: 5px; white-space: pre-wrap; word-break: break-all; }
        .sidebar-link, .history-item { cursor: pointer; }
        .sortable-header { cursor: pointer; user-select: none; }
        .sortable-header:hover { background-color: #374151 !important; }
        .sortable-header .sort-icon { float: right; opacity: 0.7; }
        queryInput {
            padding: 10px;
            background-color: #1a222b;
            color: white; /* This styles the text you type */
            border: 1px solid #555;
        }

        /* This rule targets only the placeholder of our specific input */
        queryInput::placeholder {
            color: white;
            opacity: 1; /* Override Firefox's default opacity */
        }
    </style>
</head>
<body>

<div layout:fragment="content">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>

    <div class="row">
        <div class="col-md-3">
            <h4 class="mb-3">Database Schema</h4>
            <div class="card mb-4">
                <div class="card-header" th:text="'Database: ' + ${schemaDetails.databaseName}"></div>
                <div class="list-group list-group-flush">
                    <a th:each="tableName : ${schemaDetails.tableNames}" th:text="${tableName}" th:data-tablename="${tableName}" class="list-group-item list-group-item-action sidebar-link"></a>
                </div>
            </div>
            <h4 class="mb-3">Query History</h4>
            <div class="card">
                <div class="list-group list-group-flush" id="queryHistoryList">
                    <a th:each="item : ${queryHistory}" th:data-query="${item.naturalQuery}" class="list-group-item list-group-item-action history-item">
                        <small class="text-secondary" th:text="${#temporals.format(item.executionTimestamp, 'MMM-dd HH:mm')}"></small>
                        <p class="mb-0 text-truncate" th:text="${item.naturalQuery}"></p>
                    </a>
                    <div th:if="${#lists.isEmpty(queryHistory)}" id="noHistoryMessage" class="list-group-item">No recent queries.</div>
                </div>
            </div>
        </div>

        <div class="col-md-9">
            <h3 class="mb-3">Ask a question</h3>
            <div class="mb-3">
                <textarea class="form-control" id="queryInput" rows="3" placeholder=" e.g., Show me all users from California"></textarea>
            </div>
            <button type="button" class="btn btn-primary" id="askButton">Ask</button>
            <div class="loader ms-2" id="loader"></div>
            <hr class="my-4">
            <div id="sqlQueryDisplay" class="mb-3"></div>

            <div class="d-flex justify-content-between align-items-center mb-2">
                <h4>Results</h4>
                <button class="btn btn-sm btn-outline-success" id="exportCsvBtn" style="display: none;">Export to CSV</button>
            </div>
            <div id="results" class="table-responsive">
                <p class="text-secondary">Results will appear here once you ask a question.</p>
            </div>
        </div>
    </div>

    <div class="modal fade" id="confirmationModal" tabindex="-1">
        <div class="modal-dialog"><div class="modal-content" style="background-color: var(--surface-color); border-color: var(--border-color);"><div class="modal-header"><h5 class="modal-title text-danger">⚠️ Warning</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><p id="modalWarningText"></p><p>Are you sure you want to execute this query?</p><pre id="modalSqlToConfirm"><code></code></pre></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button type="button" class="btn btn-danger" id="confirmExecuteBtn">Execute</button></div></div></div>
    </div>
</div>

<th:block layout:fragment="page-scripts">
    <script>
        let currentResults = null, currentSortColumn = null, currentSortDirection = 'asc', sqlToExecute = '';
        const exportCsvBtn = document.getElementById('exportCsvBtn'), queryInput = document.getElementById('queryInput'), queryHistoryList = document.getElementById('queryHistoryList'), askButton = document.getElementById('askButton'), resultsDiv = document.getElementById('results'), loader = document.getElementById('loader'), sqlQueryDiv = document.getElementById('sqlQueryDisplay'), confirmExecuteBtn = document.getElementById('confirmExecuteBtn'), confirmationModal = new bootstrap.Modal(document.getElementById('confirmationModal'));
        const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content'), csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content'), fetchHeaders = { 'Content-Type': 'application/json' };
        fetchHeaders[csrfHeader] = csrfToken;

        document.querySelectorAll('.history-item').forEach(item => { item.addEventListener('click', function() { queryInput.value = this.dataset.query; }); });
        document.querySelectorAll('.sidebar-link').forEach(link => { link.addEventListener('click', function(event) { event.preventDefault(); showTablePreview(this.dataset.tablename); }); });
        askButton.addEventListener('click', handleAskButtonClick);
        exportCsvBtn.addEventListener('click', () => { if (currentResults) { exportToCsv('query_results.csv', currentResults); } });
        confirmExecuteBtn.addEventListener('click', handleExecuteClick);

        function handleAskButtonClick() {
            const question = queryInput.value;
            if (!question) { resultsDiv.innerHTML = '<p class="text-danger">Please enter a question.</p>'; return; }
            currentSortColumn = null; currentSortDirection = 'asc'; currentResults = null;
            exportCsvBtn.style.display = 'none'; resultsDiv.innerHTML = ''; sqlQueryDiv.innerHTML = ''; loader.style.display = 'inline-block';
            fetch('/api/query', { method: 'POST', headers: fetchHeaders, body: JSON.stringify({ question: question }) })
                .then(response => response.json()).then(data => {
                loader.style.display = 'none';
                if (data.newHistoryItem) { addHistoryItem(data.newHistoryItem); }
                if (data.generatedSql) { sqlQueryDiv.innerHTML = `<h5>Generated SQL Query:</h5><pre><code>${data.generatedSql}</code></pre>`; }
                if (data.requiresConfirmation) {
                    document.getElementById('modalWarningText').textContent = data.warning;
                    document.querySelector('#modalSqlToConfirm code').textContent = data.generatedSql;
                    sqlToExecute = data.generatedSql;
                    confirmationModal.show();
                } else if (data.error) { resultsDiv.innerHTML = `<p class="text-danger"><strong>Error:</strong> ${data.error}</p>`; }
                else { currentResults = data; renderTable(data); }
            }).catch(handleError);
        }
        function handleExecuteClick() {
            confirmationModal.hide(); loader.style.display = 'inline-block'; resultsDiv.innerHTML = '';
            fetch('/api/execute', { method: 'POST', headers: fetchHeaders, body: JSON.stringify({ sql: sqlToExecute }) })
                .then(response => response.json()).then(data => {
                loader.style.display = 'none';
                if (data.error) { resultsDiv.innerHTML = `<p class="text-danger"><strong>Error:</strong> ${data.error}</p>`; }
                else { resultsDiv.innerHTML = `<p class="text-success">${data.message}</p>`; }
            }).catch(handleError);
        }
        function exportToCsv(filename, data) { const header = data.columns.join(','); const rows = data.rows.map(row => data.columns.map(col => { let cell = row[col] === null ? '' : String(row[col]); cell = cell.replace(/"/g, '""'); if (cell.includes(',') || cell.includes('"')) { cell = `"${cell}"`; } return cell; }).join(',')); const csvContent = [header, ...rows].join('\n'); const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' }); const link = document.createElement('a'); const url = URL.createObjectURL(blob); link.setAttribute('href', url); link.setAttribute('download', filename); link.style.visibility = 'hidden'; document.body.appendChild(link); link.click(); document.body.removeChild(link); }
        function addHistoryItem(item) { const noHistoryMessage = document.getElementById('noHistoryMessage'); if (noHistoryMessage) { noHistoryMessage.remove(); } const newLink = document.createElement('a'); newLink.className = 'list-group-item list-group-item-action history-item'; newLink.innerHTML = `<small class="text-secondary">${item.executionTimestamp}</small><p class="mb-0 text-truncate">${item.naturalQuery}</p>`; newLink.addEventListener('click', function() { queryInput.value = this.dataset.query; }); queryHistoryList.prepend(newLink); if (queryHistoryList.children.length > 10) { queryHistoryList.lastChild.remove(); } }
        function showTablePreview(tableName) { resultsDiv.innerHTML = ''; sqlQueryDiv.innerHTML = `<h5>Previewing table: <strong>${tableName}</strong></h5>`; loader.style.display = 'inline-block'; currentSortColumn = null; currentSortDirection = 'asc'; fetch('/api/table-preview', { method: 'POST', headers: fetchHeaders, body: JSON.stringify({ tableName: tableName }) }).then(response => response.json()).then(data => { loader.style.display = 'none'; if (data.error) { resultsDiv.innerHTML = `<p class="text-danger"><strong>Error:</strong> ${data.error}</p>`; } else { renderPreview(data); } }).catch(handleError); }
        function renderPreview(data) { resultsDiv.innerHTML = ''; if (data.schema && data.schema.length > 0) { const schemaTable = document.createElement('table'); schemaTable.className = 'table table-sm table-bordered table-dark'; schemaTable.innerHTML = `<thead><tr><th>Field</th><th>Type</th><th>Null</th><th>Key</th></tr></thead>`; const schemaBody = document.createElement('tbody'); data.schema.forEach(col => { const row = document.createElement('tr'); row.innerHTML = `<td>${col.Field}</td><td>${col.Type}</td><td>${col.Null}</td><td>${col.Key}</td>`; schemaBody.appendChild(row); }); schemaTable.appendChild(schemaBody); const schemaHeader = document.createElement('h5'); schemaHeader.textContent = 'Table Structure'; resultsDiv.appendChild(schemaHeader); resultsDiv.appendChild(schemaTable); } const dataHeader = document.createElement('h5'); dataHeader.textContent = 'Data Preview (First 10 Rows)'; dataHeader.className = 'mt-4'; resultsDiv.appendChild(dataHeader); currentResults = data; renderTable(data); }
        function sortTable(column) { if (!currentResults || !currentResults.rows) return; if (currentSortColumn === column) { currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc'; } else { currentSortColumn = column; currentSortDirection = 'asc'; } currentResults.rows.sort((a, b) => { const valA = a[column]; const valB = b[column]; if (valA === null) return 1; if (valB === null) return -1; if (typeof valA === 'number' && typeof valB === 'number') { return currentSortDirection === 'asc' ? valA - valB : valB - valA; } else { return currentSortDirection === 'asc' ? String(valA).localeCompare(String(valB)) : String(valB).localeCompare(String(valA)); } }); renderTable(currentResults); }
        function renderTable(data) {
            const tableResultsDiv = document.getElementById('results');
            if (!data.rows || data.rows.length === 0) { tableResultsDiv.innerHTML = '<p class="text-secondary">Query returned no results.</p>'; exportCsvBtn.style.display = 'none'; return; }
            const table = document.createElement('table'); table.className = 'table table-dark table-striped table-hover'; const thead = document.createElement('thead'); const headerRow = document.createElement('tr'); data.columns.forEach(col => { const th = document.createElement('th'); th.className = 'sortable-header'; th.textContent = col; const icon = document.createElement('span'); icon.className = 'sort-icon'; if (currentSortColumn === col) { icon.innerHTML = currentSortDirection === 'asc' ? ' &#9650;' : ' &#9660;'; } th.appendChild(icon); th.addEventListener('click', () => sortTable(col)); headerRow.appendChild(th); }); thead.appendChild(headerRow); table.appendChild(thead);
            const tbody = document.createElement('tbody'); data.rows.forEach(rowData => { const row = document.createElement('tr'); data.columns.forEach(col => { const td = document.createElement('td'); td.textContent = rowData[col] !== null ? rowData[col] : 'NULL'; row.appendChild(td); }); tbody.appendChild(row); }); table.appendChild(tbody);
            tableResultsDiv.innerHTML = ''; tableResultsDiv.appendChild(table); exportCsvBtn.style.display = 'block';
        }
        function handleError(error) { loader.style.display = 'none'; console.error('Error:', error); resultsDiv.innerHTML = `<p class="text-danger">An unexpected error occurred. Check the console.</p>`; }
    </script>
</th:block>

</body>
</html>